@page "/"

@using System.Text.Json
@using System.Text.Json.Serialization
@using System.Threading
@inject NavigationManager navigationManager
@inject ITodoItemService todoItemService
@inject NavigationManager uriHelper;


<PageTitle>Pay Your TV License Fee</PageTitle>


<center><h1 class="display-1 py-5 px-5 bg-black text-light">TV LICENSE FINE</h1></center>
<div class="lh-lg fs-5">In order to pay your TV License fine online, you will need your <b>Reference Number</b> from your Fine notice letter. <br>
No personal payment details are held - they are required for payment only and passed to the payment processor.</div>

<!--<input placeholder="Something todo" @bind="newTodo" />
<button @onclick="AddTodo">Add todo</button>
<br><br>-->
<h1 class="mb-3 py-3">Pay a fine</h1>
<input class="form-group mx-sm-3 mb-2" type="text" placeholder="Reference Number" @bind="referenceNumber" />
<input class="form-group mx-sm-3 mb-2" type="text" placeholder="Address" @bind="Address" />
<input class="form-group mx-sm-3 mb-2" type="text" placeholder="Postcode" @bind="Postcode" />
<button type="button" class="btn btn-success" @onclick="CheckRefNum">Check</button>
<p>@checkFail</p>

   

@code {
    private bool isWrong;
    private string? referenceNumber;

    private string? Address;

    private string? checkFail;

    private string? Postcode;
    private List<TodoItem> todoItems = new List<TodoItem>(); 

    private string? newTodo;

    private bool shouldRender;
    protected override bool ShouldRender() => shouldRender;

    protected override async Task OnInitializedAsync()
    {
        /*var itemList = (await todoItemService.GetTodoItems()).ToList();

        if (itemList == null)
        {
            todoItems.Clear();
        }
        else
        {
            todoItems = itemList;
        }

        shouldRender = true;*/
    }

    private async Task CheckRefNum()
    {
        var itemList = (await todoItemService.GetTodoItems()).ToList();
      
        if (itemList == null)
        {
            todoItems.Clear();
        }
        else
        {
            var item = itemList.FirstOrDefault(e => e.LetterReference == referenceNumber && e.Address1 == Address && e.PostCode == Postcode);
            todoItems = itemList;
            if (item != null)
            {
                checkFail = string.Empty;
                navigationManager.NavigateTo($"Summary/{item.Id}");
                
            }
            else 
            {
                checkFail = "Couldn't match your details, please try again.";
            }
        }

        shouldRender = true;


    }
    private async Task AddTodoItem()
    {
        TodoItem newTodoItem = new TodoItem();
        newTodoItem.Name = newTodo;
        //newTodoItem.IsComplete = false;

        var itemList = (await todoItemService.AddTodoItem(newTodoItem)).ToList();

        if (itemList == null)
        {
            //todoItems.Clear();
        }
        else
        {
            todoItems = itemList;
        }

    }

    private async Task DeleteTodoItem(TodoItem todoItem)
    {
        TodoItem newTodoItem = new TodoItem();
        newTodoItem.Name = newTodo;
        //newTodoItem.IsComplete = false;

        var itemList = (await todoItemService.DeleteTodoItem(todoItem)).ToList();

        if (itemList == null)
        {
            //todoItems.Clear();
        }
        else
        {
            todoItems = itemList;
        }

    }

    private async Task UpdateTodoItem(TodoItem todoItem)
    {
        TodoItem newTodoItem = new TodoItem();
        newTodoItem.Name = newTodo;
        //newTodoItem.IsComplete = false;

        var itemList = (await todoItemService.UpdateTodoItem(todoItem)).ToList();

        if (itemList == null)
        {
            //todoItems.Clear();
        }
        else
        {
            todoItems = itemList;
        }

    }
    
}